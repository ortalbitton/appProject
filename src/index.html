<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>AppProject</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <!--<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">-->
  <!--<link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
  <script src="https://openlayers.org/en/v4.6.5/build/ol.js" type="text/javascript"></script>-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
    integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
    crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
    integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
    crossorigin=""></script>

  <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
  <script src="https://openlayers.org/en/v4.6.5/build/ol.js" type="text/javascript"></script>

  <script src="https://d3js.org/d3.v4.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular.js"></script>
</head>

<body>
  <app-root></app-root>

  <script>
    var app = angular.module('chartApp', []);
    var salesDataToPlot;

    app.service('SalesService', ['$http', function ($http) {
      this.setAd = function () {
        this.ad = $http.get('http://localhost:3000/api/advertisements');
        return this.ad;
      };
    }]);


    app.controller('SalesController', ['$scope', 'SalesService', function ($scope, SalesService) {

      SalesService.setAd().then(function (Ad) {
        $scope.salesData = Ad.data.locations;
      });

      /*$scope.salesData = [{
          "_id": "A",
          "count": 300
        },
        {
          "_id": "B",
          "count": 150
        },
        {
          "_id": "C",
          "count": 400
        }
    
      ];*/
    }]);

    app.directive('linearChart', function ($window, SalesService) {
      return {
        restrict: 'EA',
        template: "<svg width='300' height='200'></svg>",
        scope: {
          data: '='
        },
        link: function (scope, elem, attrs) {

          var padding = 20;
          var pathClass = "path";
          var xScale, yScale, xAxisGen, yAxisGen, lineFun;

          var d3 = $window.d3;
          var rawSvg = elem.find('svg');
          var svg = d3.select(rawSvg[0]);


          //Render graph based on 'data'
          scope.render = function (data) {

            console.log(data);

            function setChartParameters() {

              xScale = d3.scaleBand()
                .domain(data.map(function (d) {
                  return d._id;
                }))
                .range([padding + 20, rawSvg.attr("width") - padding]);

              yScale = d3.scaleLinear()
                .domain([0, d3.max(data, function (d) {
                  return d.count;
                })])
                .range([rawSvg.attr("height") - padding, 0]);

              xAxisGen = d3.axisBottom()
                .scale(xScale)
                .ticks(data.length - 1);

              yAxisGen = d3.axisLeft()
                .scale(yScale)
                .ticks(2);

              lineFun = d3.line()
                .x(function (d) {
                  console.log(xScale(d._id));
                  return xScale(d._id);
                })
                .y(function (d) {
                  console.log(yScale(d.count));
                  return yScale(d.count);
                })
                .curve(d3.curveLinear);
            }

            function drawLineChart() {

              setChartParameters();

              svg.append("svg:g")
                .attr("class", "x axis")
                .attr("transform", "translate(0,180)")
                .call(xAxisGen);

              svg.append("svg:g")
                .attr("class", "y axis")
                .attr("transform", "translate(40,0)")
                .call(yAxisGen);

              svg.append("svg:path")
                .attr('d', lineFun(data))
                .attr('stroke', 'blue')
                .attr('stroke-width', 1.5)
                .attr('fill', 'none')
                .attr("transform", "translate(30,0)");

            }

            drawLineChart();
          };

          scope.$watch('data', function () {
            scope.render(scope.data);
          }, true);

        }

      };

    });

  </script>

</body>


</html>
